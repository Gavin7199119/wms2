<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sendik's Food Markets | Enterprise WMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Corporate Fonts & Colors */
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; color: #111; }
        .sendiks-red { background-color: #b91c1c; }
        .sendiks-red-text { color: #b91c1c; }
        
        /* Components */
        .panel { background: #fff; border: 1px solid #d1d5db; border-top: 4px solid #b91c1c; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-main { background-color: #b91c1c; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; font-size: 11px; padding: 10px 20px; transition: all 0.2s; }
        .btn-main:hover { background-color: #991b1b; }
        
        .input-field { width: 100%; padding: 8px; border: 1px solid #cbd5e1; outline: none; font-size: 13px; transition: border 0.2s; }
        .input-field:focus { border-color: #b91c1c; }

        /* Loading Spinner */
        .loader-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #b91c1c; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal */
        .modal-bg { background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }

        /* Status Pills */
        .status { padding: 3px 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; border-radius: 2px; border: 1px solid transparent; }
        .st-submitted { background: #fffbeb; color: #92400e; border-color: #fcd34d; }
        .st-transit { background: #eff6ff; color: #1e40af; border-color: #93c5fd; }
        .st-delivered { background: #f0fdf4; color: #166534; border-color: #86efac; }
        .st-locked { background: #f3f4f6; color: #4b5563; border-color: #d1d5db; }
        .st-disputed { background: #fef2f2; color: #b91c1c; border-color: #f87171; animation: pulse-red 2s infinite; }
        .st-refunded { background: #333; color: #fff; border-color: #000; }
        .st-resolved { background: #f3f4f6; color: #666; border-color: #ccc; text-decoration: line-through; }

        /* Animations */
        .pulse-badge { animation: pulse 1.5s infinite; background: #2563eb; color: white; font-size: 9px; padding: 2px 6px; border-radius: 2px; font-weight: bold; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="app" class="flex-1 flex flex-col"></div>

    <div id="modalLayer" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50 p-4">
        <div id="modalContent" class="bg-white p-6 shadow-2xl max-w-md w-full border-t-4 border-red-700"></div>
    </div>

<script>
/* =========================================
   1. DATA PERSISTENCE LAYER
   ========================================= */
const DB = {
    save: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    get: (k, d) => JSON.parse(localStorage.getItem(k)) || d
};

// Initial Database Seeding
let USERS = DB.get('sfm_db_users', {
    "Gavin.Beaird@sendiks.com": { password: "Yellow55!0531", role: "user" },
    "produceadmin@sendiks.com": { password: "admin", role: "admin" },
    "warehouse@sendiks.com": { password: "warehouse123", role: "warehouse" }
});

let ITEMS = DB.get('sfm_db_items', [
    {plu:"4011", name:"Bananas", price:18.95},
    {plu:"4020", name:"Fuji Apples", price:44.10},
    {plu:"4131", name:"Granny Smith", price:42.10},
    {plu:"4046", name:"Avocados Hass", price:58.75},
    {plu:"4065", name:"Green Peppers", price:22.50}
]);

let ORDERS = DB.get('sfm_db_orders', []);

/* =========================================
   2. STATE MANAGEMENT
   ========================================= */
let currentUser = null;
let view = "login";
let cart = [];
let selectedLoc = "";

/* =========================================
   3. CORE UTILITIES
   ========================================= */
function loader(cb) {
    const app = document.getElementById("app");
    // Only show loader if we aren't already rendering (prevents flicker on small updates)
    app.innerHTML = `<div class="loader-overlay"><div class="flex flex-col items-center"><div class="spinner mb-4"></div><span class="text-xs font-bold text-gray-400 tracking-widest uppercase">Syncing Mainframe...</span></div></div>`;
    setTimeout(() => { cb(); render(); }, 600);
}

function navigate(v) { loader(() => { view = v; }); }
function openModal(h) { document.getElementById("modalContent").innerHTML = h; document.getElementById("modalLayer").classList.remove('hidden'); }
function closeModal() { document.getElementById("modalLayer").classList.add('hidden'); }

/* =========================================
   4. BUSINESS LOGIC
   ========================================= */

// --- Auth ---
window.doLogin = () => {
    const e = document.getElementById("email").value;
    const p = document.getElementById("pass").value;
    if(USERS[e] && USERS[e].password === p) {
        currentUser = { email: e, role: USERS[e].role };
        navigate(currentUser.role === 'warehouse' ? 'warehouse' : 'menu');
    } else alert("Invalid Credentials.");
};

window.confirmLogout = () => {
    openModal(`
        <h3 class="font-bold text-lg mb-2">Confirm Disconnect</h3>
        <p class="text-xs text-gray-500 mb-6">Are you sure you want to log out? Unsaved data may be lost.</p>
        <div class="flex gap-2">
            <button onclick="closeModal()" class="flex-1 py-2 border text-xs font-bold uppercase">Cancel</button>
            <button onclick="currentUser=null; closeModal(); navigate('login')" class="flex-1 py-2 bg-red-700 text-white text-xs font-bold uppercase">Logout</button>
        </div>
    `);
};

// --- Ordering ---
window.updateCart = (plu, qty) => {
    const item = ITEMS.find(i => i.plu === plu);
    const q = parseInt(qty);
    const idx = cart.findIndex(c => c.plu === plu);
    if(q > 0) {
        if(idx > -1) cart[idx].qty = q; else cart.push({...item, qty: q});
    } else if (idx > -1) cart.splice(idx, 1);
};

window.submitOrder = () => {
    if(!selectedLoc || cart.length === 0) return alert("Error: Store or Items missing.");
    const id = Date.now();
    const order = {
        id: id, location: selectedLoc, items: [...cart],
        total: cart.reduce((s,i)=>s+(i.price*i.qty),0),
        status: "Submitted", timestamp: new Date().toLocaleString(),
        created: Date.now(),
        disputeReason: null
    };
    ORDERS.unshift(order);
    DB.save('sfm_db_orders', ORDERS);
    cart = []; selectedLoc = "";
    
    // 1-Minute Lock Timer
    setTimeout(() => {
        ORDERS = ORDERS.map(o => (o.id === id && o.status === "Submitted") ? {...o, status: "Locked"} : o);
        DB.save('sfm_db_orders', ORDERS);
        if(view === "history") render();
    }, 60000);

    navigate('history');
};

window.editOrder = (id) => {
    const o = ORDERS.find(ord => ord.id === id);
    if(Date.now() - o.created > 60000) return alert("Edit Window Expired.");
    selectedLoc = o.location;
    cart = [...o.items];
    ORDERS = ORDERS.filter(ord => ord.id !== id);
    DB.save('sfm_db_orders', ORDERS);
    navigate('create');
};

// --- Warehouse Logic ---
window.dispatchOrder = (id) => {
    ORDERS = ORDERS.map(o => o.id === id ? {...o, status: "In Transit"} : o);
    DB.save('sfm_db_orders', ORDERS);
    render();

    // Auto-Delivery (Random 2-7 minutes)
    const minutes = Math.floor(Math.random() * 5) + 2; 
    setTimeout(() => {
        ORDERS = ORDERS.map(o => o.id === id ? {...o, status: "Delivered"} : o);
        DB.save('sfm_db_orders', ORDERS);
        if(view === "warehouse" || view === "history") render();
    }, minutes * 60000);
};

// --- Dispute Logic ---
window.openDisputeModal = (id) => {
    openModal(`
        <h3 class="font-bold text-lg mb-2 text-red-700">File Dispute Claim</h3>
        <p class="text-xs text-gray-500 mb-4">Please provide a reason for disputing Order #${id} (e.g., Damaged, Shorted, Wrong Item).</p>
        <textarea id="disputeReason" class="w-full border p-2 text-sm h-24 mb-4 outline-none focus:border-red-700" placeholder="Enter details here..."></textarea>
        <div class="flex gap-2">
            <button onclick="closeModal()" class="flex-1 py-2 border text-xs font-bold uppercase">Cancel</button>
            <button onclick="submitDispute(${id})" class="flex-1 py-2 bg-red-700 text-white text-xs font-bold uppercase">Submit Claim</button>
        </div>
    `);
};

window.submitDispute = (id) => {
    const reason = document.getElementById("disputeReason").value;
    if(!reason) return alert("Reason required.");
    ORDERS = ORDERS.map(o => o.id === id ? {...o, status: "Disputed", disputeReason: reason} : o);
    DB.save('sfm_db_orders', ORDERS);
    closeModal();
    render();
};

window.resolveDispute = (id, resolution) => {
    // Resolution can be 'Refunded' or 'Resolved' (Rejected/Closed)
    ORDERS = ORDERS.map(o => o.id === id ? {...o, status: resolution} : o);
    DB.save('sfm_db_orders', ORDERS);
    render();
};

// --- Admin Logic ---
window.adminAct = (type, id, data) => {
    if(type === 'delItem') ITEMS = ITEMS.filter(i => i.plu !== id);
    if(type === 'addItem') ITEMS.push(data);
    if(type === 'delUser' && id !== currentUser.email) delete USERS[id];
    if(type === 'addUser') USERS[data.email] = {password: data.pass, role: data.role};
    if(type === 'cancelOrd') ORDERS = ORDERS.filter(o => o.id !== id);
    
    DB.save('sfm_db_items', ITEMS);
    DB.save('sfm_db_users', USERS);
    DB.save('sfm_db_orders', ORDERS);
    render();
};

/* =========================================
   5. VIEW RENDERING
   ========================================= */
function render() {
    const app = document.getElementById("app");

    // Login View
    if(!currentUser) {
        app.innerHTML = `
        <div class="flex-1 flex items-center justify-center p-6 bg-gray-100">
            <div class="panel p-10 w-full max-w-sm bg-white">
                <div class="mb-8 text-center">
                    <h1 class="text-3xl font-black italic sendiks-red-text tracking-tighter">Sendik's</h1>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.4em]">Food Markets</p>
                </div>
                <div class="space-y-4">
                    <input id="email" type="text" placeholder="Identity / Email" class="input-field">
                    <input id="pass" type="password" placeholder="Password" class="input-field">
                    <button onclick="doLogin()" class="w-full btn-main text-white py-3 shadow-lg">Login to WMS</button>
                </div>
            </div>
        </div>`;
        return;
    }

    // Navigation Header
    const nav = `
    <header class="bg-[#b91c1c] text-white px-6 py-4 flex justify-between items-center shadow-md">
        <div class="flex items-center gap-4">
            <span class="text-xl font-black italic tracking-tighter">SENDIK'S</span>
            <span class="text-[9px] bg-black bg-opacity-20 px-2 py-1 rounded font-bold uppercase tracking-widest">Enterprise Portal</span>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-xs font-semibold opacity-90">${currentUser.email} (${currentUser.role})</span>
            <button onclick="confirmLogout()" class="bg-black bg-opacity-30 hover:bg-opacity-50 px-3 py-1 text-[10px] font-bold uppercase rounded transition">Logout</button>
        </div>
    </header>`;

    let content = "";

    // 1. Menu View
    if(view === "menu") {
        content = `
        <div class="max-w-5xl mx-auto mt-12 grid grid-cols-1 md:grid-cols-3 gap-6 p-6">
            <div onclick="navigate('create')" class="panel p-10 cursor-pointer hover:bg-gray-50 transition text-center group">
                <div class="text-4xl mb-4 group-hover:scale-110 transition">üìã</div>
                <h3 class="font-bold text-xs uppercase tracking-widest text-gray-600">New Requisition</h3>
            </div>
            <div onclick="navigate('history')" class="panel p-10 cursor-pointer hover:bg-gray-50 transition text-center group">
                <div class="text-4xl mb-4 group-hover:scale-110 transition">üì¶</div>
                <h3 class="font-bold text-xs uppercase tracking-widest text-gray-600">Order History</h3>
            </div>
            ${currentUser.role === 'admin' ? `
            <div onclick="navigate('admin')" class="panel p-10 cursor-pointer hover:bg-gray-50 transition text-center group">
                <div class="text-4xl mb-4 group-hover:scale-110 transition">üîê</div>
                <h3 class="font-bold text-xs uppercase tracking-widest text-gray-600">Admin Control</h3>
            </div>` : ''}
        </div>`;
    }

    // 2. Create Order View
    if(view === "create") {
        content = `
        <div class="max-w-4xl mx-auto mt-8 p-6">
            <button onclick="navigate('menu')" class="text-[10px] font-bold text-gray-400 uppercase mb-4 hover:text-red-700">&larr; Dashboard</button>
            <div class="panel p-8 bg-white">
                <div class="flex gap-4 mb-6">
                    <select onchange="selectedLoc=this.value" class="input-field font-bold bg-gray-50">
                        <option value="">-- SELECT STORE LOCATION --</option>
                        ${["Whitefish Bay", "Mequon", "Brookfield", "Franklin", "Greenfield"].map(l => `<option value="${l}" ${selectedLoc===l?'selected':''}>${l}</option>`).join('')}
                    </select>
                </div>
                <div class="border rounded max-h-96 overflow-y-auto mb-6">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b sticky top-0">
                            <tr><th class="p-3 text-[10px] uppercase text-gray-500">Item Name</th><th class="p-3 text-[10px] uppercase text-gray-500">PLU</th><th class="p-3 text-right text-[10px] uppercase text-gray-500">Quantity</th></tr>
                        </thead>
                        <tbody class="divide-y">
                            ${ITEMS.map(i => `<tr>
                                <td class="p-3 font-bold text-gray-700">${i.name}</td>
                                <td class="p-3 font-mono text-gray-400 text-xs">${i.plu}</td>
                                <td class="p-3 text-right"><input type="number" placeholder="0" class="w-20 text-center border p-1" onchange="updateCart('${i.plu}', this.value)"></td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
                <button onclick="submitOrder()" class="w-full btn-main py-4 text-xs tracking-widest">Submit Requisition</button>
            </div>
        </div>`;
    }

    // 3. History View
    if(view === "history") {
        content = `
        <div class="max-w-4xl mx-auto mt-8 p-6 space-y-4">
            <button onclick="navigate('menu')" class="text-[10px] font-bold text-gray-400 uppercase hover:text-red-700">&larr; Dashboard</button>
            ${ORDERS.length === 0 ? '<p class="text-center text-gray-400 text-xs font-bold uppercase mt-10">No Records Found</p>' : ''}
            ${ORDERS.map(o => {
                const canEdit = o.status === 'Submitted' && (Date.now() - o.created < 60000);
                const canDispute = o.status === 'Delivered';
                return `
                <div class="panel p-5 flex justify-between items-center bg-white">
                    <div class="flex items-center gap-6">
                        <span class="status st-${o.status.toLowerCase().replace(' ', '')}">${o.status}</span>
                        <div>
                            <div class="font-bold text-sm uppercase">${o.location}</div>
                            <div class="text-[10px] text-gray-400 font-bold">${o.timestamp} ‚Ä¢ $${o.total.toFixed(2)}</div>
                            ${o.disputeReason ? `<div class="text-[10px] text-red-600 font-bold mt-1">‚ö†Ô∏è Issue: ${o.disputeReason}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-2 items-center">
                        ${canEdit ? `<span class="pulse-badge">WINDOW OPEN</span> <button onclick="editOrder(${o.id})" class="text-[10px] font-bold text-blue-600 underline uppercase">Edit</button>` : ''}
                        ${canDispute ? `<button onclick="openDisputeModal(${o.id})" class="text-[10px] font-bold text-red-600 border border-red-200 px-3 py-1 uppercase hover:bg-red-50">Report Issue</button>` : ''}
                        ${currentUser.role === 'admin' ? `<button onclick="adminAct('cancelOrd', ${o.id})" class="text-[10px] font-bold text-gray-400 border px-2 py-1 uppercase hover:text-red-600">Cancel</button>` : ''}
                    </div>
                </div>`;
            }).join('')}
        </div>`;
    }

    // 4. Warehouse Dashboard View
    if(view === "warehouse") {
        const queue = ORDERS.filter(o => o.status === 'Submitted' || o.status === 'Locked' || o.status === 'In Transit');
        const disputes = ORDERS.filter(o => o.status === 'Disputed');
        
        content = `
        <div class="max-w-6xl mx-auto mt-8 p-6 space-y-8">
            <div class="flex justify-between items-end">
                <h2 class="text-xl font-bold text-gray-800 italic uppercase">Warehouse Fulfillment</h2>
                <span class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded">ACTIVE: ${queue.length} | DISPUTES: ${disputes.length}</span>
            </div>

            ${disputes.length > 0 ? `
            <div class="bg-red-50 border border-red-200 p-4 rounded">
                <h3 class="text-red-800 font-bold text-xs uppercase mb-3 flex items-center gap-2">‚ö†Ô∏è Risk Management (Action Required)</h3>
                <div class="space-y-2">
                    ${disputes.map(d => `
                    <div class="bg-white p-3 border border-red-100 flex justify-between items-center shadow-sm">
                        <div>
                            <div class="font-bold text-sm text-gray-800">${d.location} <span class="text-gray-400 text-[10px]">#${d.id}</span></div>
                            <div class="text-xs text-red-600 font-bold">Claim: "${d.disputeReason}"</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="resolveDispute(${d.id}, 'Resolved')" class="bg-gray-200 text-gray-600 px-3 py-1 text-[10px] font-bold uppercase hover:bg-gray-300">Reject</button>
                            <button onclick="resolveDispute(${d.id}, 'Refunded')" class="bg-red-700 text-white px-3 py-1 text-[10px] font-bold uppercase hover:bg-red-800">Refund</button>
                        </div>
                    </div>`).join('')}
                </div>
            </div>` : ''}

            <div class="space-y-3">
                ${queue.length === 0 ? '<div class="panel p-10 text-center text-gray-400 font-bold text-xs uppercase">All Manifests Cleared</div>' : ''}
                ${queue.map(o => `
                <div class="panel p-4 flex justify-between items-center bg-white border-l-4 ${o.status==='In Transit' ? 'border-l-blue-500' : 'border-l-yellow-500'}">
                    <div class="flex items-center gap-6">
                        <span class="status st-${o.status.toLowerCase().replace(' ', '')}">${o.status}</span>
                        <div>
                            <div class="font-black text-lg uppercase text-gray-800">${o.location}</div>
                            <div class="text-[10px] text-gray-500 font-mono">ID: #${o.id} ‚Ä¢ ${o.items.length} SKUs</div>
                        </div>
                    </div>
                    <div class="text-right">
                        ${o.status === 'In Transit' ? 
                            `<span class="text-xs font-bold text-blue-600 animate-pulse">üöõ EN ROUTE (AUTO-DELIVERY ACTIVE)</span>` : 
                            `<button onclick="dispatchOrder(${o.id})" class="bg-gray-900 hover:bg-black text-white px-6 py-2 text-[10px] font-bold uppercase tracking-widest shadow">Dispatch Truck</button>`
                        }
                    </div>
                </div>
                `).join('')}
            </div>
        </div>`;
    }

    // 5. Admin View
    if(view === "admin") {
        content = `
        <div class="max-w-6xl mx-auto mt-8 p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="panel p-6 bg-white">
                <h3 class="font-bold text-xs uppercase border-b pb-2 mb-4 text-gray-500">Master Catalog</h3>
                <div class="flex gap-2 mb-4">
                    <input id="nP" placeholder="PLU" class="input-field w-20">
                    <input id="nN" placeholder="Item Name" class="input-field flex-1">
                    <input id="nPr" placeholder="Price" class="input-field w-20">
                    <button onclick="adminAct('addItem', null, {plu:document.getElementById('nP').value, name:document.getElementById('nN').value, price:parseFloat(document.getElementById('nPr').value)})" class="btn-main px-4">ADD</button>
                </div>
                <div class="max-h-60 overflow-y-auto border divide-y text-xs">
                    ${ITEMS.map(i => `<div class="p-2 flex justify-between"><span><b>${i.name}</b> (${i.plu})</span><button onclick="adminAct('delItem', '${i.plu}')" class="text-red-600 font-bold uppercase">Del</button></div>`).join('')}
                </div>
            </div>
            <div class="panel p-6 bg-white">
                <h3 class="font-bold text-xs uppercase border-b pb-2 mb-4 text-gray-500">User Access</h3>
                <div class="flex gap-2 mb-4">
                    <input id="uE" placeholder="Email" class="input-field flex-1">
                    <input id="uP" placeholder="Pass" class="input-field w-24">
                    <select id="uR" class="input-field w-24"><option>user</option><option>warehouse</option><option>admin</option></select>
                    <button onclick="adminAct('addUser', null, {email:document.getElementById('uE').value, pass:document.getElementById('uP').value, role:document.getElementById('uR').value})" class="btn-main px-4">ADD</button>
                </div>
                <div class="max-h-60 overflow-y-auto border divide-y text-xs">
                    ${Object.entries(USERS).map(([e,d]) => `<div class="p-2 flex justify-between"><span>${e} <i class="text-gray-400">(${d.role})</i></span><button onclick="adminAct('delUser', '${e}')" class="text-red-600 font-bold uppercase">Revoke</button></div>`).join('')}
                </div>
            </div>
        </div>`;
    }

    app.innerHTML = nav + `<main class="flex-1 overflow-y-auto pb-20">${content}</main>`;
}

// Initialize System
render();
</script>
</body>
</html>